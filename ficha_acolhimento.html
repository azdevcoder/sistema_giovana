<script>
    const form = document.getElementById("formFicha");
    const btn = document.getElementById("btnEnviar");
    const pdfViewer = document.getElementById("pdfViewer");
    
    // Configurações
    const contatoWhatsApp = "5544997112467"; 

    function gerarHash() { return Math.floor(10000 + Math.random() * 9000); }

    // === NOVA FUNÇÃO DE QUEBRA DE LINHA MELHORADA ===
    function quebrarTexto(texto, limiteCaracteres) {
        if (!texto) return [""];
        
        // 1. Divide primeiro pelos "Enters" (quebra de parágrafo do usuário)
        const paragrafos = texto.split('\n');
        let linhasFinais = [];

        paragrafos.forEach(paragrafo => {
            // Se o parágrafo for vazio (linha em branco), adiciona espaço
            if (paragrafo.trim() === "") {
                linhasFinais.push(""); 
                return;
            }

            // 2. Divide parágrafos longos em linhas menores
            const palavras = paragrafo.split(' ');
            let linhaAtual = palavras[0];

            for (let i = 1; i < palavras.length; i++) {
                if (linhaAtual.length + 1 + palavras[i].length <= limiteCaracteres) {
                    linhaAtual += " " + palavras[i];
                } else {
                    linhasFinais.push(linhaAtual);
                    linhaAtual = palavras[i];
                }
            }
            linhasFinais.push(linhaAtual);
        });

        return linhasFinais;
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.innerHTML = '<span class="spinner"></span> Gerando PDF...';

        try {
            const pdfDoc = await PDFLib.PDFDocument.create();
            let page = pdfDoc.addPage([595.28, 841.89]); // A4
            const { width, height } = page.getSize();
            
            const fontRegular = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
            const fontBold = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);

            // Variáveis de layout
            let y = height - 50; 
            const margin = 50;
            const lineHeight = 14; // Altura entre linhas
            const fontSize = 10;

            // Função para desenhar linhas e atualizar o Y automaticamente
            const escreverLinhas = (linhas) => {
                linhas.forEach(linha => {
                    // Verifica se a página acabou
                    if (y < 40) { 
                        page = pdfDoc.addPage([595.28, 841.89]); 
                        y = height - 50; 
                    }
                    page.drawText(linha, { x: margin, y, size: fontSize, font: fontRegular });
                    y -= lineHeight;
                });
                y -= 5; // Espaço extra após bloco de texto
            };

            // Função para desenhar campos simples (Label: Valor)
            const drawField = (label, value) => {
                const valorLimpo = value ? String(value).toUpperCase() : "-";
                page.drawText(label, { x: margin, y, size: fontSize, font: fontBold });
                // Posiciona o valor logo após o label (estimativa de largura: 6px por letra)
                const labelWidth = label.length * 5.5; 
                page.drawText(valorLimpo, { x: margin + labelWidth + 10, y, size: fontSize, font: fontRegular });
                y -= lineHeight * 1.5;
            };

            // Função para Títulos
            const drawSection = (title) => {
                y -= 10;
                page.drawText(title, { x: margin, y, size: 12, font: fontBold });
                y -= 5;
                page.drawLine({ start: { x: margin, y: y }, end: { x: width - margin, y: y }, thickness: 0.5 });
                y -= 20;
            };

            // === CABEÇALHO ===
            page.drawText('FICHA DE ACOLHIMENTO', { x: margin, y, size: 16, font: fontBold });
            y -= 25;
            page.drawText('Psicóloga Giovana', { x: margin, y, size: 12, font: fontRegular, color: PDFLib.rgb(0.4, 0.4, 0.4) });
            y -= 30;

            // === 1. IDENTIFICAÇÃO ===
            drawSection("1. IDENTIFICAÇÃO PESSOAL");
            drawField("Nome:", document.getElementById("nome").value);
            
            const nasc = document.getElementById("nascimento").value.split('-').reverse().join('/');
            drawField("Data Nasc:", nasc);
            if(document.getElementById("nomeSocial").value) drawField("Nome Social:", document.getElementById("nomeSocial").value);
            
            // Endereço (pode ser longo, então usamos a quebra)
            page.drawText("Endereço:", { x: margin, y, size: fontSize, font: fontBold });
            y -= lineHeight;
            escreverLinhas(quebrarTexto(document.getElementById("endereco").value, 95));

            drawField("Profissão:", document.getElementById("profissao").value);
            drawField("Religião:", document.getElementById("religiao").value);
            drawField("Escolaridade:", document.getElementById("escolaridade").value);
            drawField("Telefone:", document.getElementById("telefone").value);
            drawField("E-mail:", document.getElementById("email").value);

            // === 2. PAIS ===
            drawSection("2. IDENTIFICAÇÃO DOS PAIS");
            
            page.drawText("PAI:", { x: margin, y, size: fontSize, font: fontBold }); y -= lineHeight;
            drawField("Nome:", document.getElementById("paiNome").value);
            page.drawText(`Idade: ${document.getElementById("paiIdade").value}   Profissão: ${document.getElementById("paiProfissao").value}   Escolaridade: ${document.getElementById("paiEscolaridade").value}`, { x: margin, y, size: fontSize, font: fontRegular });
            y -= lineHeight * 2;

            page.drawText("MÃE:", { x: margin, y, size: fontSize, font: fontBold }); y -= lineHeight;
            drawField("Nome:", document.getElementById("maeNome").value);
            page.drawText(`Idade: ${document.getElementById("maeIdade").value}   Profissão: ${document.getElementById("maeProfissao").value}   Escolaridade: ${document.getElementById("maeEscolaridade").value}`, { x: margin, y, size: fontSize, font: fontRegular });
            y -= lineHeight * 2;

            page.drawText("Endereço dos Pais:", { x: margin, y, size: fontSize, font: fontBold });
            y -= lineHeight;
            escreverLinhas(quebrarTexto(document.getElementById("paisEndereco").value, 95));

            // === 3. QUEIXA (Aqui é onde o texto costuma ser grande) ===
            // Verifica espaço antes de começar a seção grande
            if (y < 250) { page = pdfDoc.addPage([595.28, 841.89]); y = height - 50; }
            
            drawSection("3. QUEIXA PRINCIPAL");
            
            // Queixa
            page.drawText("Descreva a queixa principal:", { x: margin, y, size: fontSize, font: fontBold });
            y -= lineHeight;
            // Limite de 95 caracteres por linha
            escreverLinhas(quebrarTexto(document.getElementById("queixa").value, 95));
            y -= 10;

            // Evolução
            page.drawText("Evolução (Como começou):", { x: margin, y, size: fontSize, font: fontBold });
            y -= lineHeight;
            escreverLinhas(quebrarTexto(document.getElementById("evolucao").value, 95));
            y -= 10;

            drawField("Início:", document.getElementById("inicioTipo").value);

            // Sintomas
            page.drawText("Sintomas atuais:", { x: margin, y, size: fontSize, font: fontBold });
            y -= lineHeight;
            escreverLinhas(quebrarTexto(document.getElementById("sintomas").value, 95));

            // === 4. MEDICAMENTOS ===
            if (y < 100) { page = pdfDoc.addPage([595.28, 841.89]); y = height - 50; }
            drawSection("4. MEDICAMENTOS");
            drawField("Usa Medicamentos?", document.getElementById("usoMedicamento").value);
            
            page.drawText("Quais:", { x: margin, y, size: fontSize, font: fontBold });
            y -= lineHeight;
            escreverLinhas(quebrarTexto(document.getElementById("quaisMedicamentos").value, 95));

            // === FINALIZAÇÃO ===
            page.drawText(`Gerado em: ${new Date().toLocaleString()}`, { x: margin, y: 30, size: 8, font: fontRegular, color: PDFLib.rgb(0.6, 0.6, 0.6) });

            const pdfBytes = await pdfDoc.save();
            const pdfBlob = new Blob([pdfBytes], { type: "application/pdf" });
            const localUrl = URL.createObjectURL(pdfBlob);
            
            pdfViewer.style.display = "block";
            pdfViewer.src = localUrl;

            // === ENVIOS ===
            const hash = gerarHash();
            const nomeFinal = `${hash}_Ficha_${document.getElementById("nome").value.split(" ")[0]}.pdf`;
            const base64 = await blobParaBase64(pdfBlob);
            
            try {
                await fetch("https://ficha-acolhimento.onrender.com/upload", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ nomeArquivo: nomeFinal, conteudoBase64: base64 })
                });
            } catch (e) { console.warn("Upload falhou, seguindo fluxo local."); }

            const link = document.createElement('a');
            link.href = localUrl;
            link.download = nomeFinal;
            link.click();

            const msg = encodeURIComponent(`Olá Giovana, preenchi a Ficha de Acolhimento.\nPaciente: ${document.getElementById("nome").value}`);
            window.open(`https://wa.me/${contatoWhatsApp}?text=${msg}`, "_blank");

            alert("Ficha gerada com sucesso!");

        } catch (err) {
            console.error(err);
            alert("Erro: " + err.message);
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    });

    function blobParaBase64(blob) {
        return new Promise((r) => {
            const reader = new FileReader();
            reader.onloadend = () => r(reader.result.split(",")[1]);
            reader.readAsDataURL(blob);
        });
    }
</script>
