<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ficha de Acolhimento - Psicóloga Giovana</title>
<style>
    body { font-family: Arial, sans-serif; background: #f3e8db; padding: 20px; text-align: center; color: #333; }
    .container { background: #fff; padding: 30px; max-width: 800px; margin: auto; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); text-align: left; }
    
    h2 { color: #000000; text-align: center; text-transform: uppercase; margin-bottom: 20px; }
    h3 { color: #555; border-bottom: 2px solid #f3e8db; padding-bottom: 5px; margin-top: 30px; font-size: 1.1em; }
    
    label { font-size: 0.9em; font-weight: bold; display: block; margin-top: 10px; }
    input, select, textarea { padding: 10px; margin: 5px 0 15px 0; width: 100%; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    textarea { resize: vertical; height: 80px; }
    
    /* Layout em colunas para campos menores */
    .row { display: flex; gap: 15px; flex-wrap: wrap; }
    .col-half { flex: 1; min-width: 200px; }
    .col-third { flex: 1; min-width: 150px; }
    
    button { width: 100%; padding: 15px; background: #f3e8db; color: black; font-weight: bold; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; transition: 0.3s; margin-top: 20px; }
    button:hover { background: #a35e4c; color: white; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid white; border-top: 2px solid #ffaddd; border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: middle; margin-right: 8px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    iframe { width: 100%; height: 600px; border: 1px solid #ddd; margin-top: 25px; display: none; }
</style>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
</head>
<body>
<img src="banner_assinatura.png" alt="Banner de Assinatura" style="max-width: 30%;">

<div class="container">
    <h2>Ficha de Acolhimento</h2>
    <form id="formFicha">
        
        <h3>1. Identificação Pessoal</h3>
        <label>Nome Completo:</label>
        <input type="text" id="nome" required>
        
        <div class="row">
            <div class="col-half">
                <label>Nome Social:</label>
                <input type="text" id="nomeSocial">
            </div>
            <div class="col-half">
                <label>Data de Nascimento:</label>
                <input type="date" id="nascimento" required>
            </div>
        </div>

        <label>Endereço Completo:</label>
        <input type="text" id="endereco">

        <div class="row">
            <div class="col-third">
                <label>Profissão:</label>
                <input type="text" id="profissao"required>
            </div>
            <div class="col-third">
                <label>Religião:</label>
                <input type="text" id="religiao">
            </div>
            <div class="col-third">
                <label>Escolaridade:</label>
                <input type="text" id="escolaridade">
            </div>
        </div>

        <div class="row">
            <div class="col-half">
                <label>Telefone / WhatsApp:</label>
                <input type="text" id="telefone" required>
            </div>
            <div class="col-half">
                <label>E-mail:</label>
                <input type="email" id="email"required>
            </div>
        </div>

        <h3>2. Identificação dos Pais</h3>
        
        <label>Nome do Pai:</label>
        <input type="text" id="paiNome">
        <div class="row">
            <div class="col-third"><label>Idade:</label><input type="number" id="paiIdade"></div>
            <div class="col-third"><label>Profissão:</label><input type="text" id="paiProfissao"></div>
            <div class="col-third"><label>Escolaridade:</label><input type="text" id="paiEscolaridade"></div>
        </div>

        <label>Nome da Mãe:</label>
        <input type="text" id="maeNome">
        <div class="row">
            <div class="col-third"><label>Idade:</label><input type="number" id="maeIdade"></div>
            <div class="col-third"><label>Profissão:</label><input type="text" id="maeProfissao"></div>
            <div class="col-third"><label>Escolaridade:</label><input type="text" id="maeEscolaridade"></div>
        </div>

        <label>Endereço dos Pais (se diferente):</label>
        <input type="text" id="paisEndereco">

        <h3>3. Queixa Principal</h3>
        <label>Descreva a queixa principal:</label>
        <textarea id="queixa"></textarea>

        <label>Evolução da queixa (Como começou?):</label>
        <textarea id="evolucao"required></textarea>

        <label>O início foi repentino ou gradual?</label>
        <select id="inicioTipo" required>
            <option value="">Selecione...</option>
            <option value="Repentino">Repentino</option>
            <option value="Gradual">Gradual</option>
        </select>

        <label>Sintomas atuais:</label>
        <textarea id="sintomas"></textarea>

        <h3>4. Medicamentos</h3>
        <label>Faz uso de medicamentos?</label>
        <select id="usoMedicamento"required>
            <option value="Não">Não</option>
            <option value="Sim">Sim</option>
        </select>

        <label>Se sim, qual(is)?</label>
        <input type="text" id="quaisMedicamentos">

        <button type="submit" id="btnEnviar">Gerar Ficha e Enviar</button>
    </form>

    <iframe id="pdfViewer"></iframe>
</div>

<script>
    const form = document.getElementById("formFicha");
    const btn = document.getElementById("btnEnviar");
    const pdfViewer = document.getElementById("pdfViewer");
    
    // Configurações Globais
    const contatoWhatsApp = "5544997112467"; 
    const nomeArquivoPDF = "FichaTemplate.pdf"; // Nome do seu arquivo PDF base

    function gerarHash() { return Math.floor(10000 + Math.random() * 9000); }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.innerHTML = '<span class="spinner"></span> Processando...';

        // Coleta de Dados
        const dados = {
            nome: document.getElementById("nome").value,
            nomeSocial: document.getElementById("nomeSocial").value,
            nascimento: document.getElementById("nascimento").value.split('-').reverse().join('/'),
            endereco: document.getElementById("endereco").value,
            profissao: document.getElementById("profissao").value,
            religiao: document.getElementById("religiao").value,
            escolaridade: document.getElementById("escolaridade").value,
            telefone: document.getElementById("telefone").value,
            email: document.getElementById("email").value,
            
            paiNome: document.getElementById("paiNome").value,
            paiIdade: document.getElementById("paiIdade").value,
            paiProfissao: document.getElementById("paiProfissao").value,
            paiEscolaridade: document.getElementById("paiEscolaridade").value,
            
            maeNome: document.getElementById("maeNome").value,
            maeIdade: document.getElementById("maeIdade").value,
            maeProfissao: document.getElementById("maeProfissao").value,
            maeEscolaridade: document.getElementById("maeEscolaridade").value,
            paisEndereco: document.getElementById("paisEndereco").value,

            queixa: document.getElementById("queixa").value,
            evolucao: document.getElementById("evolucao").value,
            inicioTipo: document.getElementById("inicioTipo").value,
            sintomas: document.getElementById("sintomas").value,
            usoMedicamento: document.getElementById("usoMedicamento").value,
            quaisMedicamentos: document.getElementById("quaisMedicamentos").value
        };

        try {
            // 1. Carregar o PDF base
            const res = await fetch(nomeArquivoPDF);
            if (!res.ok) throw new Error(`Arquivo ${nomeArquivoPDF} não encontrado na pasta.`);
            const existingPdfBytes = await res.arrayBuffer();
            const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
            const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
            
            // Pega a primeira página
            const pages = pdfDoc.getPages();
            const page = pages[0];
            const { height } = page.getSize();
            const size = 10; // Tamanho da fonte

            // === PREENCHIMENTO DO PDF ===
            // DICA: Ajuste os valores de X e Y para alinhar com as linhas do seu PDF
            // X = Horizontal (esquerda p/ direita), Y = Vertical (baixo p/ cima)

            // Dados Pessoais
            page.drawText(dados.nome, { x: 130, y: height - 120, size, font });
            if(dados.nomeSocial) page.drawText(dados.nomeSocial, { x: 130, y: height - 140, size, font });
            page.drawText(dados.nascimento, { x: 450, y: height - 140, size, font });
            
            page.drawText(dados.endereco, { x: 80, y: height - 165, size, font });
            page.drawText(dados.profissao, { x: 80, y: height - 185, size, font });
            page.drawText(dados.religiao, { x: 250, y: height - 185, size, font });
            page.drawText(dados.escolaridade, { x: 400, y: height - 185, size, font });
            page.drawText(dados.telefone, { x: 80, y: height - 205, size, font });
            page.drawText(dados.email, { x: 250, y: height - 205, size, font });

            // Dados dos Pais
            page.drawText(dados.paiNome, { x: 100, y: height - 250, size, font });
            page.drawText(dados.paiIdade, { x: 350, y: height - 250, size, font });
            page.drawText(dados.paiProfissao, { x: 420, y: height - 250, size, font });
            
            page.drawText(dados.maeNome, { x: 100, y: height - 275, size, font });
            page.drawText(dados.maeIdade, { x: 350, y: height - 275, size, font });
            page.drawText(dados.maeProfissao, { x: 420, y: height - 275, size, font });
            
            page.drawText(dados.paisEndereco, { x: 100, y: height - 300, size, font });

            // Queixa e Sintomas (Deslocados mais para baixo)
            // Se o texto for longo, ele não quebra linha sozinho. Para textos longos seria ideal usar drawText com maxWidth (biblioteca avançada) ou quebras manuais.
            page.drawText(dados.queixa, { x: 50, y: height - 380, size, font });
            page.drawText(dados.evolucao, { x: 50, y: height - 450, size, font });
            page.drawText(dados.inicioTipo, { x: 150, y: height - 480, size, font });
            page.drawText(dados.sintomas, { x: 50, y: height - 520, size, font });

            // Medicamentos
            page.drawText(dados.usoMedicamento, { x: 180, y: height - 600, size, font });
            page.drawText(dados.quaisMedicamentos, { x: 250, y: height - 600, size, font });


            // Salvar PDF
            const pdfBytes = await pdfDoc.save();
            const pdfBlob = new Blob([pdfBytes], { type: "application/pdf" });
            const localUrl = URL.createObjectURL(pdfBlob);
            
            // Mostrar no Iframe
            pdfViewer.style.display = "block";
            pdfViewer.src = localUrl;

            // === Upload Backend (igual referência) ===
            const hash = gerarHash();
            const nomeFinal = `${hash}_Ficha_${dados.nome.split(" ")[0]}.pdf`;
            const base64 = await blobParaBase64(pdfBlob);
            
            // Nota: Se você não tiver configurado o backend para receber 'Ficha', 
            // isso pode dar erro ou salvar na mesma pasta dos contratos.
            await fetch("https://contratos-assinados.onrender.com/upload", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ nomeArquivo: nomeFinal, conteudoBase64: base64 })
            });

            // Download
            const link = document.createElement('a');
            link.href = localUrl;
            link.download = nomeFinal;
            link.click();

            // WhatsApp
            const msg = encodeURIComponent(`Olá Giovana, preenchi a Ficha de Acolhimento.\nPaciente: ${dados.nome}`);
            window.open(`https://wa.me/${contatoWhatsApp}?text=${msg}`, "_blank");

            alert("Ficha enviada e baixada com sucesso!");

        } catch (err) {
            console.error(err);
            alert("Erro ao processar: " + err.message);
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    });

    function blobParaBase64(blob) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(",")[1]);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    }
</script>

</body>
</html>