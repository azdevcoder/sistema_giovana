<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ficha de Acolhimento - Psicóloga Giovana</title>
<link rel="icon" type="image/png" href="Logo-Giovana-Morais-_52-x-52-px_.ico">
<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f3e8db; padding: 20px; text-align: center; color: #333; }
    .container { background: #fff; padding: 40px; max-width: 800px; margin: auto; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: left; }
    
    h2 { color: #d68c98; text-align: center; text-transform: uppercase; margin-bottom: 25px; letter-spacing: 1px; }
    h3 { color: #555; border-bottom: 2px solid #f3e8db; padding-bottom: 8px; margin-top: 35px; font-size: 1.1em; }
    
    label { font-size: 0.9em; font-weight: bold; display: block; margin-top: 12px; color: #444; }
    input, select, textarea { padding: 12px; margin: 5px 0 15px 0; width: 100%; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; background-color: #fafafa; transition: 0.3s; }
    input:focus, textarea:focus { border-color: #d68c98; outline: none; background-color: #fff; }
    textarea { resize: vertical; height: 100px; font-family: inherit; }
    
    .row { display: flex; gap: 20px; flex-wrap: wrap; }
    .col-half { flex: 1; min-width: 200px; }
    .col-third { flex: 1; min-width: 150px; }
    
    button { width: 100%; padding: 16px; background: #f3e8db; color: #444; font-weight: bold; font-size: 16px; border: 1px solid #e0d0c0; border-radius: 6px; cursor: pointer; transition: 0.3s; margin-top: 30px; text-transform: uppercase; letter-spacing: 1px; }
    button:hover { background: #a35e4c; color: white; border-color: #d68c98; }
    button:disabled { background: #ccc; cursor: not-allowed; border-color: #ccc; }
    
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid white; border-top: 2px solid #333; border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: middle; margin-right: 8px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    iframe { width: 100%; height: 700px; border: 1px solid #ddd; margin-top: 30px; border-radius: 8px; display: none; background: #eee; }
</style>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
</head>
<body>

<img src="banner_assinatura.png" alt="Banner" style="max-width: 500px; margin-bottom: 20px; border-radius: 5px;">

<div class="container">
    <h2>Ficha de Acolhimento - Psicoterapia</h2>
    <form id="formFicha">
        
        <h3>1. Identificação Pessoal</h3>
        <label>Nome Completo:</label>
        <input type="text" id="nome" required placeholder="Digite seu nome completo">
        
        <div class="row">
            <div class="col-half">
                <label>Nome Social:</label>
                <input type="text" id="nomeSocial">
            </div>
            <div class="col-half">
                <label>Data de Nascimento:</label>
                <input type="date" id="nascimento" required>
            </div>
        </div>

        <label>Endereço Completo:</label>
        <input type="text" id="endereco" placeholder="Rua, número, bairro, cidade">

        <div class="row">
            <div class="col-third">
                <label>Profissão:</label>
                <input type="text" id="profissao" required>
            </div>
            <div class="col-third">
                <label>Religião:</label>
                <input type="text" id="religiao">
            </div>
            <div class="col-third">
                <label>Escolaridade:</label>
                <input type="text" id="escolaridade">
            </div>
        </div>

        <div class="row">
            <div class="col-half">
                <label>Telefone / WhatsApp:</label>
                <input type="text" id="telefone" required placeholder="(XX) XXXXX-XXXX">
            </div>
            <div class="col-half">
                <label>E-mail:</label>
                <input type="email" id="email" required>
            </div>
        </div>

        <h3>2. Identificação dos Pais</h3>
        
        <label>Nome do Pai:</label>
        <input type="text" id="paiNome">
        <div class="row">
            <div class="col-third"><label>Idade:</label><input type="number" id="paiIdade"></div>
            <div class="col-third"><label>Profissão:</label><input type="text" id="paiProfissao"></div>
            <div class="col-third"><label>Escolaridade:</label><input type="text" id="paiEscolaridade"></div>
        </div>

        <label>Nome da Mãe:</label>
        <input type="text" id="maeNome">
        <div class="row">
            <div class="col-third"><label>Idade:</label><input type="number" id="maeIdade"></div>
            <div class="col-third"><label>Profissão:</label><input type="text" id="maeProfissao"></div>
            <div class="col-third"><label>Escolaridade:</label><input type="text" id="maeEscolaridade"></div>
        </div>

        <label>Endereço dos Pais (se diferente):</label>
        <input type="text" id="paisEndereco">

        <h3>3. Queixa Principal</h3>
        <label>Descreva a queixa principal:</label>
        <textarea id="queixa" placeholder="O que te trouxe à terapia?"></textarea>

        <label>Evolução da queixa (Como começou?):</label>
        <textarea id="evolucao" required></textarea>

        <label>O início foi repentino ou gradual?</label>
        <select id="inicioTipo" required>
            <option value="">Selecione...</option>
            <option value="Repentino">Repentino</option>
            <option value="Gradual">Gradual</option>
        </select>

        <label>Sintomas atuais:</label>
        <textarea id="sintomas"></textarea>

        <h3>4. Medicamentos</h3>
        <label>Faz uso de medicamentos?</label>
        <select id="usoMedicamento" required>
            <option value="Não">Não</option>
            <option value="Sim">Sim</option>
        </select>

        <label>Se sim, qual(is)?</label>
        <input type="text" id="quaisMedicamentos">

        <button type="submit" id="btnEnviar">Gerar Ficha e Enviar</button>
    </form>

    <iframe id="pdfViewer"></iframe>
</div>

<script>
    const form = document.getElementById("formFicha");
    const btn = document.getElementById("btnEnviar");
    const pdfViewer = document.getElementById("pdfViewer");
    
    // Configurações
    const contatoWhatsApp = "5544997112467"; 

    function gerarHash() { return Math.floor(10000 + Math.random() * 9000); }

    // === NOVA FUNÇÃO INTELIGENTE DE QUEBRA DE LINHA ===
    // Mede o tamanho real do texto baseado na fonte e no limite de largura da página
    function wrapText(text, maxWidth, font, fontSize) {
        if (!text) return [""];
        const paragraphs = text.split('\n');
        let lines = [];

        for (const paragraph of paragraphs) {
            const words = paragraph.split(' ');
            let currentLine = "";

            for (const word of words) {
                // Testa se a palavra cabe na linha atual
                const testLine = currentLine ? currentLine + " " + word : word;
                const width = font.widthOfTextAtSize(testLine, fontSize);

                if (width <= maxWidth) {
                    currentLine = testLine;
                } else {
                    // Se não couber, salva a linha anterior e começa uma nova
                    if (currentLine) lines.push(currentLine);
                    currentLine = word;
                }
            }
            if (currentLine) lines.push(currentLine);
        }
        return lines;
    }

  const nomeFinal = `${hash}_Ficha_${document.getElementById("nome").value.replace(/\s+/g, "_")}.pdf`;
const base64 = await blobParaBase64(pdfBlob);

try {
    // Certifique-se de usar a URL correta do seu Render
    await fetch("https://seu-app-no-render.onrender.com/upload", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
            nomeArquivo: nomeFinal, 
            conteudoBase64: base64,
            tipo: 'ficha' 
        })
    });
} catch (e) { console.warn("Upload falhou, seguindo fluxo local."); }
            // Variáveis de layout
            let y = height - 50; 
            const margin = 50;
            const contentWidth = width - (margin * 2); // Largura útil (~495 pts)
            const lineHeight = 14; 
            const fontSize = 10;

            // Função para desenhar linhas e atualizar o Y automaticamente
            const escreverLinhas = (linhas) => {
                linhas.forEach(linha => {
                    // Verifica se a página acabou (rodapé)
                    if (y < 40) { 
                        page = pdfDoc.addPage([595.28, 841.89]); 
                        y = height - 50; 
                    }
                    page.drawText(linha, { x: margin, y, size: fontSize, font: fontRegular });
                    y -= lineHeight;
                });
                y -= 5; // Espaço extra após bloco de texto
            };

            // Função para desenhar campos simples (Label: Valor)
            const drawField = (label, value) => {
                const valorLimpo = value ? String(value).toUpperCase() : "-";
                page.drawText(label, { x: margin, y, size: fontSize, font: fontBold });
                
                const labelWidth = fontBold.widthOfTextAtSize(label, fontSize);
                page.drawText(valorLimpo, { x: margin + labelWidth + 5, y, size: fontSize, font: fontRegular });
                y -= lineHeight * 1.5;
            };

            // Função para Títulos
            const drawSection = (title) => {
                y -= 10;
                page.drawText(title, { x: margin, y, size: 12, font: fontBold });
                y -= 5;
                page.drawLine({ start: { x: margin, y: y }, end: { x: width - margin, y: y }, thickness: 0.5 });
                y -= 20;
            };

            // === CABEÇALHO ===
            page.drawText('FICHA DE ACOLHIMENTO - PSICOTERAPIA', { x: margin, y, size: 16, font: fontBold });
            y -= 25;
            page.drawText('Psicóloga Giovana CRP:08/45995 ', { x: margin, y, size: 12, font: fontRegular, color: PDFLib.rgb(0.4, 0.4, 0.4) });
            y -= 30;

            // === 1. IDENTIFICAÇÃO ===
            drawSection("1. IDENTIFICAÇÃO PESSOAL");
            drawField("Nome:", document.getElementById("nome").value);
            
            const nasc = document.getElementById("nascimento").value.split('-').reverse().join('/');
            drawField("Data Nasc:", nasc);
            if(document.getElementById("nomeSocial").value) drawField("Nome Social:", document.getElementById("nomeSocial").value);
            
            // Endereço (usando a quebra inteligente)
            page.drawText("Endereço:", { x: margin, y, size: fontSize, font: fontBold });
            y -= lineHeight;
            escreverLinhas(wrapText(document.getElementById("endereco").value, contentWidth, fontRegular, fontSize));

            drawField("Profissão:", document.getElementById("profissao").value);
            drawField("Religião:", document.getElementById("religiao").value);
            drawField("Escolaridade:", document.getElementById("escolaridade").value);
            drawField("Telefone:", document.getElementById("telefone").value);
            drawField("E-mail:", document.getElementById("email").value);

            // === 2. PAIS ===
            drawSection("2. IDENTIFICAÇÃO DOS PAIS");
            
            page.drawText("PAI:", { x: margin, y, size: fontSize, font: fontBold }); y -= lineHeight;
            drawField("Nome:", document.getElementById("paiNome").value);
            page.drawText(`Idade: ${document.getElementById("paiIdade").value}   Profissão: ${document.getElementById("paiProfissao").value}   Escolaridade: ${document.getElementById("paiEscolaridade").value}`, { x: margin, y, size: fontSize, font: fontRegular });
            y -= lineHeight * 2;

            page.drawText("MÃE:", { x: margin, y, size: fontSize, font: fontBold }); y -= lineHeight;
            drawField("Nome:", document.getElementById("maeNome").value);
            page.drawText(`Idade: ${document.getElementById("maeIdade").value}   Profissão: ${document.getElementById("maeProfissao").value}   Escolaridade: ${document.getElementById("maeEscolaridade").value}`, { x: margin, y, size: fontSize, font: fontRegular });
            y -= lineHeight * 2;

            page.drawText("Endereço dos Pais:", { x: margin, y, size: fontSize, font: fontBold });
            y -= lineHeight;
            escreverLinhas(wrapText(document.getElementById("paisEndereco").value, contentWidth, fontRegular, fontSize));

            // === 3. QUEIXA ===
            if (y < 250) { page = pdfDoc.addPage([595.28, 841.89]); y = height - 50; }
            
            drawSection("3. QUEIXA PRINCIPAL");
            
            page.drawText("Descreva a queixa principal:", { x: margin, y, size: fontSize, font: fontBold });
            y -= lineHeight;
            // Aqui usamos o wrapText passando a largura máxima (contentWidth)
            escreverLinhas(wrapText(document.getElementById("queixa").value, contentWidth, fontRegular, fontSize));
            y -= 10;

            page.drawText("Evolução (Como começou):", { x: margin, y, size: fontSize, font: fontBold });
            y -= lineHeight;
            escreverLinhas(wrapText(document.getElementById("evolucao").value, contentWidth, fontRegular, fontSize));
            y -= 10;

            drawField("Início:", document.getElementById("inicioTipo").value);

            page.drawText("Sintomas atuais:", { x: margin, y, size: fontSize, font: fontBold });
            y -= lineHeight;
            escreverLinhas(wrapText(document.getElementById("sintomas").value, contentWidth, fontRegular, fontSize));

            // === 4. MEDICAMENTOS ===
            if (y < 100) { page = pdfDoc.addPage([595.28, 841.89]); y = height - 50; }
            drawSection("4. MEDICAMENTOS");
            drawField("Usa Medicamentos?", document.getElementById("usoMedicamento").value);
            
            page.drawText("Quais:", { x: margin, y, size: fontSize, font: fontBold });
            y -= lineHeight;
            escreverLinhas(wrapText(document.getElementById("quaisMedicamentos").value, contentWidth, fontRegular, fontSize));

            // === FINALIZAÇÃO ===
            page.drawText(`Gerado em: ${new Date().toLocaleString()}`, { x: margin, y: 30, size: 8, font: fontRegular, color: PDFLib.rgb(0.6, 0.6, 0.6) });

            const pdfBytes = await pdfDoc.save();
            const pdfBlob = new Blob([pdfBytes], { type: "application/pdf" });
            const localUrl = URL.createObjectURL(pdfBlob);
            
            pdfViewer.style.display = "block";
            pdfViewer.src = localUrl;

            // === ENVIOS ===
            const hash = gerarHash();
            const nomeFinal = `${hash}_Ficha_${document.getElementById("nome").value.split(" ")[0]}.pdf`;
            const base64 = await blobParaBase64(pdfBlob);
            
            try {
                await fetch("https://ficha-acolhimento.onrender.com/upload", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ nomeArquivo: nomeFinal, conteudoBase64: base64 })
                });
            } catch (e) { console.warn("Upload falhou, seguindo fluxo local."); }

            const link = document.createElement('a');
            link.href = localUrl;
            link.download = nomeFinal;
            link.click();

            const msg = encodeURIComponent(`Olá Giovana, preenchi a Ficha de Acolhimento.\nPaciente: ${document.getElementById("nome").value}`);
            window.open(`https://wa.me/${contatoWhatsApp}?text=${msg}`, "_blank");

            alert("Ficha gerada com sucesso!");

        } catch (err) {
            console.error(err);
            alert("Erro: " + err.message);
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    });

    function blobParaBase64(blob) {
        return new Promise((r) => {
            const reader = new FileReader();
            reader.onloadend = () => r(reader.result.split(",")[1]);
            reader.readAsDataURL(blob);
        });
    }
</script>

</body>
</html>

